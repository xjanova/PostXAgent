<Page x:Class="MyPostXAgent.UI.Views.Pages.GroupSearchPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
      Title="Group Search"
      Background="{DynamicResource MaterialDesign.Brush.Background}">
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Border Background="{DynamicResource MaterialDesign.Brush.Card.Background}"
                Padding="20,15" CornerRadius="0,0,8,8">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <StackPanel>
                    <TextBlock Text="ค้นหากลุ่ม" FontSize="24" FontWeight="Bold"
                               Foreground="{DynamicResource MaterialDesign.Brush.Foreground}"/>
                    <TextBlock Text="ค้นหาและเข้าร่วมกลุ่มบน Social Media" FontSize="13" Opacity="0.7" Margin="0,4,0,0"/>
                </StackPanel>
                <Button Grid.Column="1" Style="{StaticResource MaterialDesignOutlinedButton}"
                        Command="{Binding ExportGroupsCommand}">
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="Export" VerticalAlignment="Center"/>
                        <TextBlock Text="Export" Margin="8,0,0,0"/>
                    </StackPanel>
                </Button>
            </Grid>
        </Border>

        <!-- Main Content with Tabs -->
        <TabControl Grid.Row="1" Margin="15"
                    Style="{StaticResource MaterialDesignFilledTabControl}"
                    SelectedIndex="{Binding SelectedTabIndex}">

            <!-- Search Tab -->
            <TabItem>
                <TabItem.Header>
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="Magnify" VerticalAlignment="Center"/>
                        <TextBlock Text="ค้นหา" Margin="8,0,0,0"/>
                    </StackPanel>
                </TabItem.Header>
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="320"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Search Filters Panel -->
                    <Border Background="{DynamicResource MaterialDesign.Brush.Card.Background}"
                            CornerRadius="12" Margin="0,15,15,15" Padding="20">
                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                            <StackPanel>
                                <TextBlock Text="ตัวกรองการค้นหา" FontWeight="Bold" FontSize="16" Margin="0,0,0,20"/>

                                <!-- Platform Selection -->
                                <TextBlock Text="แพลตฟอร์ม" FontSize="12" Opacity="0.7" Margin="0,0,0,8"/>
                                <ComboBox ItemsSource="{Binding Platforms}"
                                          SelectedItem="{Binding SelectedPlatform}"
                                          Style="{StaticResource MaterialDesignOutlinedComboBox}"
                                          Margin="0,0,0,15"/>

                                <!-- Search Query -->
                                <TextBlock Text="คำค้นหา" FontSize="12" Opacity="0.7" Margin="0,0,0,8"/>
                                <TextBox Text="{Binding SearchQuery, UpdateSourceTrigger=PropertyChanged}"
                                         Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                         materialDesign:HintAssist.Hint="เช่น: ขายของออนไลน์, การตลาด..."
                                         Margin="0,0,0,15">
                                    <TextBox.InputBindings>
                                        <KeyBinding Key="Return" Command="{Binding SearchCommand}"/>
                                    </TextBox.InputBindings>
                                </TextBox>

                                <!-- Category -->
                                <TextBlock Text="หมวดหมู่" FontSize="12" Opacity="0.7" Margin="0,0,0,8"/>
                                <ComboBox ItemsSource="{Binding Categories}"
                                          SelectedItem="{Binding SelectedCategory}"
                                          Style="{StaticResource MaterialDesignOutlinedComboBox}"
                                          Margin="0,0,0,15"/>

                                <!-- Min Members -->
                                <TextBlock Text="จำนวนสมาชิกขั้นต่ำ" FontSize="12" Opacity="0.7" Margin="0,0,0,8"/>
                                <ComboBox SelectedValue="{Binding MinMembers}"
                                          Style="{StaticResource MaterialDesignOutlinedComboBox}"
                                          Margin="0,0,0,15">
                                    <ComboBoxItem Content="ไม่จำกัด" Tag="0"/>
                                    <ComboBoxItem Content="1,000+" Tag="1000"/>
                                    <ComboBoxItem Content="5,000+" Tag="5000"/>
                                    <ComboBoxItem Content="10,000+" Tag="10000"/>
                                    <ComboBoxItem Content="50,000+" Tag="50000"/>
                                    <ComboBoxItem Content="100,000+" Tag="100000"/>
                                </ComboBox>

                                <!-- Only Open Groups -->
                                <CheckBox Content="เฉพาะกลุ่มสาธารณะ"
                                          IsChecked="{Binding OnlyOpenGroups}"
                                          Margin="0,0,0,20"/>

                                <!-- Search Buttons -->
                                <Button Style="{StaticResource MaterialDesignRaisedButton}"
                                        Command="{Binding SearchCommand}"
                                        IsEnabled="{Binding IsSearching, Converter={StaticResource InverseBooleanConverter}}"
                                        Margin="0,0,0,10">
                                    <StackPanel Orientation="Horizontal">
                                        <materialDesign:PackIcon Kind="Magnify" VerticalAlignment="Center"/>
                                        <TextBlock Text="ค้นหากลุ่ม" Margin="8,0,0,0"/>
                                    </StackPanel>
                                </Button>
                                <Button Style="{StaticResource MaterialDesignOutlinedButton}"
                                        Command="{Binding ClearSearchCommand}">
                                    <StackPanel Orientation="Horizontal">
                                        <materialDesign:PackIcon Kind="Close" VerticalAlignment="Center"/>
                                        <TextBlock Text="ล้างการค้นหา" Margin="8,0,0,0"/>
                                    </StackPanel>
                                </Button>

                                <!-- Search Progress -->
                                <StackPanel Visibility="{Binding IsSearching, Converter={StaticResource BooleanToVisibilityConverter}}"
                                            Margin="0,20,0,0">
                                    <TextBlock Text="{Binding SearchStatus}" FontSize="12" Margin="0,0,0,8"/>
                                    <ProgressBar Value="{Binding SearchProgress}" Minimum="0" Maximum="100" Height="6"/>
                                </StackPanel>

                                <!-- Results Count -->
                                <Border Background="{DynamicResource MaterialDesign.Brush.Primary}"
                                        CornerRadius="8" Padding="15" Margin="0,20,0,0"
                                        Visibility="{Binding TotalResults, Converter={StaticResource IntToVisibilityConverter}}">
                                    <StackPanel HorizontalAlignment="Center">
                                        <TextBlock Text="{Binding TotalResults}" FontSize="28" FontWeight="Bold"
                                                   Foreground="White" HorizontalAlignment="Center"/>
                                        <TextBlock Text="กลุ่มที่พบ" Foreground="White" Opacity="0.8"
                                                   HorizontalAlignment="Center"/>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </ScrollViewer>
                    </Border>

                    <!-- Search Results -->
                    <Border Grid.Column="1" Background="{DynamicResource MaterialDesign.Brush.Card.Background}"
                            CornerRadius="12" Margin="0,15,0,15" Padding="20">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <TextBlock Text="ผลการค้นหา" FontWeight="Bold" FontSize="16" Margin="0,0,0,15"/>

                            <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                                <ItemsControl ItemsSource="{Binding SearchResults}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Background="{DynamicResource MaterialDesign.Brush.Background}"
                                                    CornerRadius="10" Margin="0,0,0,10" Padding="15">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="50"/>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                    </Grid.ColumnDefinitions>

                                                    <!-- Platform Icon -->
                                                    <Border Background="{DynamicResource MaterialDesign.Brush.Primary}"
                                                            CornerRadius="8" Width="50" Height="50">
                                                        <materialDesign:PackIcon Kind="AccountGroup" Width="28" Height="28"
                                                                                  Foreground="White" HorizontalAlignment="Center"
                                                                                  VerticalAlignment="Center"/>
                                                    </Border>

                                                    <!-- Group Info -->
                                                    <StackPanel Grid.Column="1" Margin="15,0,0,0" VerticalAlignment="Center">
                                                        <TextBlock Text="{Binding Name}" FontWeight="SemiBold" FontSize="14"/>
                                                        <StackPanel Orientation="Horizontal" Margin="0,5,0,0">
                                                            <TextBlock Opacity="0.6" FontSize="12">
                                                                <Run Text="{Binding MemberCountFormatted}"/>
                                                                <Run Text=" สมาชิก"/>
                                                            </TextBlock>
                                                            <TextBlock Text=" • " Opacity="0.4"/>
                                                            <TextBlock Text="{Binding Category}" Opacity="0.6" FontSize="12"/>
                                                            <TextBlock Text=" • " Opacity="0.4"/>
                                                            <materialDesign:PackIcon Width="14" Height="14" Margin="0,1,3,0"
                                                                                      Opacity="0.6" VerticalAlignment="Center">
                                                                <materialDesign:PackIcon.Style>
                                                                    <Style TargetType="materialDesign:PackIcon">
                                                                        <Setter Property="Kind" Value="Lock"/>
                                                                        <Style.Triggers>
                                                                            <DataTrigger Binding="{Binding IsPublic}" Value="True">
                                                                                <Setter Property="Kind" Value="Earth"/>
                                                                            </DataTrigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </materialDesign:PackIcon.Style>
                                                            </materialDesign:PackIcon>
                                                            <TextBlock FontSize="12" Opacity="0.6">
                                                                <TextBlock.Style>
                                                                    <Style TargetType="TextBlock">
                                                                        <Setter Property="Text" Value="ส่วนตัว"/>
                                                                        <Style.Triggers>
                                                                            <DataTrigger Binding="{Binding IsPublic}" Value="True">
                                                                                <Setter Property="Text" Value="สาธารณะ"/>
                                                                            </DataTrigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </TextBlock.Style>
                                                            </TextBlock>
                                                        </StackPanel>
                                                        <TextBlock Text="{Binding Description}" Opacity="0.5" FontSize="11"
                                                                   TextTrimming="CharacterEllipsis" MaxWidth="400"
                                                                   Margin="0,3,0,0"/>
                                                    </StackPanel>

                                                    <!-- Actions -->
                                                    <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                                                        <Button Style="{StaticResource MaterialDesignIconButton}"
                                                                Command="{Binding DataContext.ViewGroupCommand, RelativeSource={RelativeSource AncestorType=Page}}"
                                                                CommandParameter="{Binding}" ToolTip="ดูรายละเอียด">
                                                            <materialDesign:PackIcon Kind="Eye"/>
                                                        </Button>
                                                        <Button Style="{StaticResource MaterialDesignRaisedButton}"
                                                                Command="{Binding DataContext.JoinGroupCommand, RelativeSource={RelativeSource AncestorType=Page}}"
                                                                CommandParameter="{Binding}" Margin="10,0,0,0"
                                                                Padding="15,5">
                                                            <StackPanel Orientation="Horizontal">
                                                                <materialDesign:PackIcon Kind="Plus" VerticalAlignment="Center" Width="18" Height="18"/>
                                                                <TextBlock Text="เข้าร่วม" Margin="5,0,0,0"/>
                                                            </StackPanel>
                                                        </Button>
                                                    </StackPanel>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>

                            <!-- Empty State -->
                            <StackPanel Grid.Row="1" VerticalAlignment="Center" HorizontalAlignment="Center"
                                        Visibility="{Binding SearchResults.Count, Converter={StaticResource ZeroToVisibilityConverter}}">
                                <materialDesign:PackIcon Kind="AccountGroupOutline" Width="80" Height="80"
                                                         Opacity="0.2" HorizontalAlignment="Center"/>
                                <TextBlock Text="ยังไม่มีผลการค้นหา" FontSize="16" Opacity="0.4"
                                           HorizontalAlignment="Center" Margin="0,15,0,5"/>
                                <TextBlock Text="ใส่คำค้นหาและกดปุ่ม 'ค้นหากลุ่ม'" FontSize="12" Opacity="0.3"
                                           HorizontalAlignment="Center"/>
                            </StackPanel>
                        </Grid>
                    </Border>
                </Grid>
            </TabItem>

            <!-- Joined Groups Tab -->
            <TabItem>
                <TabItem.Header>
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="AccountCheck" VerticalAlignment="Center"/>
                        <TextBlock Text="กลุ่มที่เข้าร่วม" Margin="8,0,0,0"/>
                        <Border Background="{DynamicResource MaterialDesign.Brush.Primary}"
                                CornerRadius="10" Padding="8,2" Margin="8,0,0,0">
                            <TextBlock Text="{Binding JoinedGroups.Count}" FontSize="11" Foreground="White"/>
                        </Border>
                    </StackPanel>
                </TabItem.Header>
                <Grid Margin="0,15,0,0">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Toolbar -->
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,15">
                        <Button Style="{StaticResource MaterialDesignOutlinedButton}"
                                Command="{Binding RefreshJoinedCommand}">
                            <StackPanel Orientation="Horizontal">
                                <materialDesign:PackIcon Kind="Refresh" VerticalAlignment="Center"/>
                                <TextBlock Text="รีเฟรช" Margin="8,0,0,0"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>

                    <!-- Joined Groups List -->
                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{Binding JoinedGroups}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <UniformGrid Columns="2"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Background="{DynamicResource MaterialDesign.Brush.Card.Background}"
                                            CornerRadius="12" Margin="0,0,15,15" Padding="20">
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>

                                            <!-- Header -->
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>
                                                <StackPanel>
                                                    <TextBlock Text="{Binding Name}" FontWeight="Bold" FontSize="16"/>
                                                    <TextBlock Text="{Binding Platform}" Opacity="0.6" FontSize="12"/>
                                                </StackPanel>
                                                <Border Grid.Column="1" Background="#4CAF50" CornerRadius="4" Padding="8,3">
                                                    <TextBlock Text="เข้าร่วมแล้ว" FontSize="10" Foreground="White"/>
                                                </Border>
                                            </Grid>

                                            <!-- Stats -->
                                            <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,15,0,0">
                                                <Border Background="{DynamicResource MaterialDesign.Brush.Background}"
                                                        CornerRadius="6" Padding="10,5" Margin="0,0,10,0">
                                                    <StackPanel Orientation="Horizontal">
                                                        <materialDesign:PackIcon Kind="Account" Width="16" Height="16" Opacity="0.6"/>
                                                        <TextBlock Text="{Binding MemberCountFormatted}" Margin="5,0,0,0" FontSize="12"/>
                                                    </StackPanel>
                                                </Border>
                                                <Border Background="{DynamicResource MaterialDesign.Brush.Background}"
                                                        CornerRadius="6" Padding="10,5">
                                                    <StackPanel Orientation="Horizontal">
                                                        <materialDesign:PackIcon Kind="Post" Width="16" Height="16" Opacity="0.6"/>
                                                        <TextBlock Margin="5,0,0,0" FontSize="12">
                                                            <Run Text="~"/>
                                                            <Run Text="{Binding PostsPerDay}"/>
                                                            <Run Text="/วัน"/>
                                                        </TextBlock>
                                                    </StackPanel>
                                                </Border>
                                            </StackPanel>

                                            <!-- Joined Date -->
                                            <TextBlock Grid.Row="2" Opacity="0.5" FontSize="11" Margin="0,10,0,0">
                                                <Run Text="เข้าร่วมเมื่อ: "/>
                                                <Run Text="{Binding JoinedAt, StringFormat=dd MMM yyyy}"/>
                                            </TextBlock>

                                            <!-- Actions -->
                                            <StackPanel Grid.Row="3" Orientation="Horizontal" Margin="0,15,0,0">
                                                <Button Style="{StaticResource MaterialDesignRaisedButton}"
                                                        Command="{Binding DataContext.PostToGroupCommand, RelativeSource={RelativeSource AncestorType=Page}}"
                                                        CommandParameter="{Binding}" Margin="0,0,10,0">
                                                    <StackPanel Orientation="Horizontal">
                                                        <materialDesign:PackIcon Kind="Send" VerticalAlignment="Center"/>
                                                        <TextBlock Text="โพสต์" Margin="8,0,0,0"/>
                                                    </StackPanel>
                                                </Button>
                                                <Button Style="{StaticResource MaterialDesignOutlinedSecondaryButton}"
                                                        Command="{Binding DataContext.LeaveGroupCommand, RelativeSource={RelativeSource AncestorType=Page}}"
                                                        CommandParameter="{Binding}">
                                                    <StackPanel Orientation="Horizontal">
                                                        <materialDesign:PackIcon Kind="ExitToApp" VerticalAlignment="Center"/>
                                                        <TextBlock Text="ออก" Margin="8,0,0,0"/>
                                                    </StackPanel>
                                                </Button>
                                            </StackPanel>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>

                    <!-- Empty State -->
                    <StackPanel Grid.Row="1" VerticalAlignment="Center" HorizontalAlignment="Center"
                                Visibility="{Binding JoinedGroups.Count, Converter={StaticResource ZeroToVisibilityConverter}}">
                        <materialDesign:PackIcon Kind="AccountGroupOutline" Width="80" Height="80"
                                                 Opacity="0.2" HorizontalAlignment="Center"/>
                        <TextBlock Text="ยังไม่ได้เข้าร่วมกลุ่มใด" FontSize="16" Opacity="0.4"
                                   HorizontalAlignment="Center" Margin="0,15,0,5"/>
                        <TextBlock Text="ค้นหาและเข้าร่วมกลุ่มเพื่อเริ่มโพสต์" FontSize="12" Opacity="0.3"
                                   HorizontalAlignment="Center"/>
                    </StackPanel>
                </Grid>
            </TabItem>
        </TabControl>

        <!-- Loading Overlay -->
        <Border Grid.RowSpan="2" Background="#80000000"
                Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <ProgressBar Style="{StaticResource MaterialDesignCircularProgressBar}"
                             IsIndeterminate="True" Width="50" Height="50"/>
                <TextBlock Text="กำลังโหลด..." Foreground="White" Margin="0,15,0,0" FontSize="14"/>
            </StackPanel>
        </Border>
    </Grid>
</Page>
