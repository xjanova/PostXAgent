<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:AIManager.Mobile.ViewModels"
             xmlns:models="clr-namespace:AIManager.Mobile.Models"
             x:Class="AIManager.Mobile.Views.DashboardPage"
             x:DataType="vm:DashboardViewModel"
             Title="แดชบอร์ด"
             BackgroundColor="{StaticResource DarkBackground}">

    <RefreshView IsRefreshing="{Binding IsBusy}"
                 Command="{Binding RefreshCommand}">
        <ScrollView>
            <VerticalStackLayout Padding="16" Spacing="16">

                <!-- Connection Status Card -->
                <Frame BackgroundColor="{StaticResource CardBackground}"
                       CornerRadius="12"
                       Padding="16"
                       BorderColor="Transparent">
                    <VerticalStackLayout Spacing="12">
                        <Grid ColumnDefinitions="Auto,*,Auto">
                            <Frame Grid.Column="0"
                                   CornerRadius="25"
                                   HeightRequest="50"
                                   WidthRequest="50"
                                   Padding="0"
                                   BackgroundColor="{StaticResource CardBackgroundLight}"
                                   BorderColor="Transparent">
                                <Label Text="&#xE30D;"
                                       FontFamily="MaterialIcons"
                                       FontSize="24"
                                       TextColor="{Binding ConnectionColor}"
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center"/>
                            </Frame>

                            <VerticalStackLayout Grid.Column="1" Margin="12,0" VerticalOptions="Center">
                                <Label Text="AI Manager Core"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource PrimaryText}"/>
                                <Label Text="{Binding ConnectionStatus}"
                                       FontSize="13"
                                       TextColor="{Binding ConnectionColor}"/>
                            </VerticalStackLayout>

                            <Button Grid.Column="2"
                                    Text="เชื่อมต่อ"
                                    Command="{Binding ConnectCommand}"
                                    BackgroundColor="{StaticResource PrimaryColor}"
                                    TextColor="{StaticResource PrimaryText}"
                                    CornerRadius="8"
                                    Padding="16,8"
                                    IsVisible="{Binding IsConnected, Converter={StaticResource InvertedBoolConverter}}"/>
                        </Grid>

                        <!-- API Key Status -->
                        <Grid ColumnDefinitions="Auto,*,Auto"
                              IsVisible="{Binding FullConnectionStatus, Converter={StaticResource NullToBoolConverter}}">
                            <Label Grid.Column="0"
                                   Text="&#xE897;"
                                   FontFamily="MaterialIcons"
                                   FontSize="18"
                                   TextColor="{StaticResource MutedText}"
                                   VerticalOptions="Center"/>
                            <Label Grid.Column="1"
                                   Text="API Key:"
                                   FontSize="13"
                                   TextColor="{StaticResource SecondaryText}"
                                   Margin="8,0"
                                   VerticalOptions="Center"/>
                            <HorizontalStackLayout Grid.Column="2" Spacing="4">
                                <Label Text="{Binding IsApiKeyValid, Converter={StaticResource ApiKeyValidToTextConverter}}"
                                       FontSize="13"
                                       TextColor="{Binding IsApiKeyValid, Converter={StaticResource ApiKeyValidToColorConverter}}"
                                       VerticalOptions="Center"/>
                                <Label Text="&#xE5CA;"
                                       FontFamily="MaterialIcons"
                                       FontSize="16"
                                       TextColor="{StaticResource SuccessColor}"
                                       IsVisible="{Binding IsApiKeyValid}"
                                       VerticalOptions="Center"/>
                                <Label Text="&#xE5CD;"
                                       FontFamily="MaterialIcons"
                                       FontSize="16"
                                       TextColor="{StaticResource ErrorColor}"
                                       IsVisible="{Binding IsApiKeyValid, Converter={StaticResource InvertedBoolConverter}}"
                                       VerticalOptions="Center"/>
                            </HorizontalStackLayout>
                        </Grid>

                        <!-- Server Version -->
                        <Grid ColumnDefinitions="Auto,*,Auto"
                              IsVisible="{Binding ServerVersion, Converter={StaticResource NullToBoolConverter}}">
                            <Label Grid.Column="0"
                                   Text="&#xE30C;"
                                   FontFamily="MaterialIcons"
                                   FontSize="18"
                                   TextColor="{StaticResource MutedText}"
                                   VerticalOptions="Center"/>
                            <Label Grid.Column="1"
                                   Text="Server Version:"
                                   FontSize="13"
                                   TextColor="{StaticResource SecondaryText}"
                                   Margin="8,0"
                                   VerticalOptions="Center"/>
                            <Label Grid.Column="2"
                                   Text="{Binding ServerVersion}"
                                   FontSize="13"
                                   TextColor="{StaticResource PrimaryText}"
                                   VerticalOptions="Center"/>
                        </Grid>
                    </VerticalStackLayout>
                </Frame>

                <!-- Stats Grid -->
                <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto" ColumnSpacing="12" RowSpacing="12">
                    <!-- Pending Tasks -->
                    <Frame Grid.Row="0" Grid.Column="0"
                           BackgroundColor="{StaticResource CardBackground}"
                           CornerRadius="12"
                           Padding="16"
                           BorderColor="Transparent">
                        <VerticalStackLayout>
                            <Label Text="&#xE8B5;"
                                   FontFamily="MaterialIcons"
                                   FontSize="28"
                                   TextColor="{StaticResource WarningColor}"/>
                            <Label Text="{Binding PendingTasks}"
                                   FontSize="28"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource PrimaryText}"/>
                            <Label Text="งานรอดำเนินการ"
                                   FontSize="12"
                                   TextColor="{StaticResource SecondaryText}"/>
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Running Tasks -->
                    <Frame Grid.Row="0" Grid.Column="1"
                           BackgroundColor="{StaticResource CardBackground}"
                           CornerRadius="12"
                           Padding="16"
                           BorderColor="Transparent">
                        <VerticalStackLayout>
                            <Label Text="&#xE863;"
                                   FontFamily="MaterialIcons"
                                   FontSize="28"
                                   TextColor="{StaticResource SecondaryColor}"/>
                            <Label Text="{Binding RunningTasks}"
                                   FontSize="28"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource PrimaryText}"/>
                            <Label Text="กำลังทำงาน"
                                   FontSize="12"
                                   TextColor="{StaticResource SecondaryText}"/>
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Workers -->
                    <Frame Grid.Row="1" Grid.Column="0"
                           BackgroundColor="{StaticResource CardBackground}"
                           CornerRadius="12"
                           Padding="16"
                           BorderColor="Transparent">
                        <VerticalStackLayout>
                            <Label Text="&#xE7FD;"
                                   FontFamily="MaterialIcons"
                                   FontSize="28"
                                   TextColor="{StaticResource SuccessColor}"/>
                            <Label FontSize="28"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource PrimaryText}">
                                <Label.Text>
                                    <MultiBinding StringFormat="{}{0}/{1}">
                                        <Binding Path="ActiveWorkers"/>
                                        <Binding Path="TotalWorkers"/>
                                    </MultiBinding>
                                </Label.Text>
                            </Label>
                            <Label Text="Workers ใช้งาน"
                                   FontSize="12"
                                   TextColor="{StaticResource SecondaryText}"/>
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Pending Payments -->
                    <Frame Grid.Row="1" Grid.Column="1"
                           BackgroundColor="{StaticResource CardBackground}"
                           CornerRadius="12"
                           Padding="16"
                           BorderColor="Transparent">
                        <VerticalStackLayout>
                            <Label Text="&#xE227;"
                                   FontFamily="MaterialIcons"
                                   FontSize="28"
                                   TextColor="{StaticResource AccentColor}"/>
                            <Label Text="{Binding PendingPayments}"
                                   FontSize="28"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource PrimaryText}"/>
                            <Label Text="รอตรวจสอบเงิน"
                                   FontSize="12"
                                   TextColor="{StaticResource SecondaryText}"/>
                        </VerticalStackLayout>
                    </Frame>
                </Grid>

                <!-- System Performance -->
                <Frame BackgroundColor="{StaticResource CardBackground}"
                       CornerRadius="12"
                       Padding="16"
                       BorderColor="Transparent">
                    <VerticalStackLayout Spacing="12">
                        <Label Text="ประสิทธิภาพระบบ"
                               FontSize="16"
                               FontAttributes="Bold"
                               TextColor="{StaticResource PrimaryText}"/>

                        <!-- CPU Usage -->
                        <Grid ColumnDefinitions="Auto,*,Auto">
                            <Label Grid.Column="0" Text="CPU"
                                   TextColor="{StaticResource SecondaryText}"
                                   WidthRequest="60"/>
                            <ProgressBar Grid.Column="1"
                                         Progress="{Binding CpuUsage, Converter={StaticResource PercentConverter}}"
                                         ProgressColor="{StaticResource PrimaryColor}"/>
                            <Label Grid.Column="2"
                                   Text="{Binding CpuUsage, StringFormat='{0:F0}%'}"
                                   TextColor="{StaticResource PrimaryText}"
                                   WidthRequest="45"
                                   HorizontalTextAlignment="End"/>
                        </Grid>

                        <!-- Memory Usage -->
                        <Grid ColumnDefinitions="Auto,*,Auto">
                            <Label Grid.Column="0" Text="Memory"
                                   TextColor="{StaticResource SecondaryText}"
                                   WidthRequest="60"/>
                            <ProgressBar Grid.Column="1"
                                         Progress="{Binding MemoryUsage, Converter={StaticResource PercentConverter}}"
                                         ProgressColor="{StaticResource SecondaryColor}"/>
                            <Label Grid.Column="2"
                                   Text="{Binding MemoryUsage, StringFormat='{0:F0}%'}"
                                   TextColor="{StaticResource PrimaryText}"
                                   WidthRequest="45"
                                   HorizontalTextAlignment="End"/>
                        </Grid>
                    </VerticalStackLayout>
                </Frame>

                <!-- Today's Payments -->
                <Frame BackgroundColor="{StaticResource CardBackground}"
                       CornerRadius="12"
                       Padding="16"
                       BorderColor="Transparent">
                    <VerticalStackLayout>
                        <Label Text="ยอดเงินเข้าวันนี้"
                               FontSize="14"
                               TextColor="{StaticResource SecondaryText}"/>
                        <Label Text="{Binding TotalPaymentsToday, StringFormat='฿{0:N2}'}"
                               FontSize="32"
                               FontAttributes="Bold"
                               TextColor="{StaticResource SuccessColor}"/>
                    </VerticalStackLayout>
                </Frame>

                <!-- Recent Tasks -->
                <Frame BackgroundColor="{StaticResource CardBackground}"
                       CornerRadius="12"
                       Padding="16"
                       BorderColor="Transparent">
                    <VerticalStackLayout Spacing="12">
                        <Label Text="งานล่าสุด"
                               FontSize="16"
                               FontAttributes="Bold"
                               TextColor="{StaticResource PrimaryText}"/>

                        <CollectionView ItemsSource="{Binding RecentTasks}"
                                        HeightRequest="200">
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:TaskItem">
                                    <Frame BackgroundColor="{StaticResource CardBackgroundLight}"
                                           CornerRadius="8"
                                           Padding="12"
                                           Margin="0,4"
                                           BorderColor="Transparent">
                                        <Grid ColumnDefinitions="Auto,*,Auto">
                                            <Label Grid.Column="0"
                                                   Text="{Binding PlatformIcon}"
                                                   FontFamily="MaterialIcons"
                                                   FontSize="20"
                                                   TextColor="{StaticResource PrimaryColor}"
                                                   VerticalOptions="Center"/>
                                            <VerticalStackLayout Grid.Column="1" Margin="12,0">
                                                <Label Text="{Binding TypeText}"
                                                       FontSize="14"
                                                       TextColor="{StaticResource PrimaryText}"/>
                                                <Label Text="{Binding CreatedAt, StringFormat='{0:dd/MM HH:mm}'}"
                                                       FontSize="11"
                                                       TextColor="{StaticResource MutedText}"/>
                                            </VerticalStackLayout>
                                            <Frame Grid.Column="2"
                                                   CornerRadius="4"
                                                   Padding="8,4"
                                                   BackgroundColor="{Binding StatusColor}"
                                                   BorderColor="Transparent">
                                                <Label Text="{Binding StatusText}"
                                                       FontSize="10"
                                                       TextColor="White"/>
                                            </Frame>
                                        </Grid>
                                    </Frame>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                            <CollectionView.EmptyView>
                                <Label Text="ไม่มีงานล่าสุด"
                                       TextColor="{StaticResource MutedText}"
                                       HorizontalOptions="Center"/>
                            </CollectionView.EmptyView>
                        </CollectionView>
                    </VerticalStackLayout>
                </Frame>

            </VerticalStackLayout>
        </ScrollView>
    </RefreshView>

</ContentPage>
