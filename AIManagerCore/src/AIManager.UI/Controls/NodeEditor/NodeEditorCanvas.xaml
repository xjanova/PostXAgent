<UserControl x:Class="AIManager.UI.Controls.NodeEditor.NodeEditorCanvas"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             mc:Ignorable="d"
             d:DesignHeight="600" d:DesignWidth="800"
             Background="Transparent"
             Focusable="True"
             KeyDown="Canvas_KeyDown">

    <UserControl.Resources>
        <!-- Connection Line Style -->
        <Style x:Key="ConnectionLineStyle" TargetType="Path">
            <Setter Property="StrokeThickness" Value="3"/>
            <Setter Property="Stroke">
                <Setter.Value>
                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                        <GradientStop Color="#8B5CF6" Offset="0"/>
                        <GradientStop Color="#EC4899" Offset="1"/>
                    </LinearGradientBrush>
                </Setter.Value>
            </Setter>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect Color="#8B5CF6" BlurRadius="8" ShadowDepth="0" Opacity="0.6"/>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Grid Pattern Brush -->
        <DrawingBrush x:Key="GridBrush" TileMode="Tile" Viewport="0,0,50,50" ViewportUnits="Absolute">
            <DrawingBrush.Drawing>
                <GeometryDrawing>
                    <GeometryDrawing.Pen>
                        <Pen Brush="#15FFFFFF" Thickness="1"/>
                    </GeometryDrawing.Pen>
                    <GeometryDrawing.Geometry>
                        <GeometryGroup>
                            <LineGeometry StartPoint="0,0" EndPoint="50,0"/>
                            <LineGeometry StartPoint="0,0" EndPoint="0,50"/>
                        </GeometryGroup>
                    </GeometryDrawing.Geometry>
                </GeometryDrawing>
            </DrawingBrush.Drawing>
        </DrawingBrush>
    </UserControl.Resources>

    <Grid>
        <!-- Background Grid -->
        <Border x:Name="BackgroundGrid" Background="{StaticResource GridBrush}">
            <Border.RenderTransform>
                <TransformGroup>
                    <ScaleTransform x:Name="GridScaleTransform" ScaleX="1" ScaleY="1"/>
                    <TranslateTransform x:Name="GridTranslateTransform"/>
                </TransformGroup>
            </Border.RenderTransform>
        </Border>

        <!-- Canvas Container with Zoom/Pan -->
        <Border ClipToBounds="True"
                MouseWheel="Canvas_MouseWheel"
                MouseLeftButtonDown="Canvas_MouseLeftButtonDown"
                MouseLeftButtonUp="Canvas_MouseLeftButtonUp"
                MouseRightButtonDown="Canvas_MouseRightButtonDown"
                MouseMove="Canvas_MouseMove"
                AllowDrop="True"
                Drop="Canvas_Drop"
                DragOver="Canvas_DragOver">

            <Canvas x:Name="NodeCanvas">
                <Canvas.RenderTransform>
                    <TransformGroup>
                        <ScaleTransform x:Name="CanvasScale" ScaleX="1" ScaleY="1"/>
                        <TranslateTransform x:Name="CanvasTranslate"/>
                    </TransformGroup>
                </Canvas.RenderTransform>

                <!-- Connection Layer (behind nodes) -->
                <Canvas x:Name="ConnectionLayer"/>

                <!-- Temporary Connection Line (when dragging) -->
                <Path x:Name="TempConnectionLine"
                      Style="{StaticResource ConnectionLineStyle}"
                      Visibility="Collapsed"/>

                <!-- Selection Rectangle -->
                <Border x:Name="SelectionRect"
                        Background="#208B5CF6"
                        BorderBrush="#8B5CF6"
                        BorderThickness="1"
                        CornerRadius="3"
                        Visibility="Collapsed"/>

                <!-- Node Layer (on top) -->
                <Canvas x:Name="NodeLayer"/>
            </Canvas>
        </Border>

        <!-- Toolbar -->
        <Border VerticalAlignment="Top" HorizontalAlignment="Left"
                Background="#40000000" CornerRadius="10" Padding="5" Margin="10">
            <StackPanel Orientation="Horizontal">
                <Button x:Name="BtnZoomIn" Click="ZoomIn_Click"
                        Style="{StaticResource MaterialDesignIconButton}"
                        ToolTip="Zoom In" Margin="2">
                    <materialDesign:PackIcon Kind="MagnifyPlus" Width="20" Height="20"/>
                </Button>
                <Button x:Name="BtnZoomOut" Click="ZoomOut_Click"
                        Style="{StaticResource MaterialDesignIconButton}"
                        ToolTip="Zoom Out" Margin="2">
                    <materialDesign:PackIcon Kind="MagnifyMinus" Width="20" Height="20"/>
                </Button>
                <Button x:Name="BtnFitView" Click="FitView_Click"
                        Style="{StaticResource MaterialDesignIconButton}"
                        ToolTip="Fit to View" Margin="2">
                    <materialDesign:PackIcon Kind="FitToScreen" Width="20" Height="20"/>
                </Button>
                <Border Width="1" Background="#30FFFFFF" Margin="5,2"/>
                <Button x:Name="BtnUndo" Click="Undo_Click"
                        Style="{StaticResource MaterialDesignIconButton}"
                        ToolTip="Undo (Ctrl+Z)" Margin="2">
                    <materialDesign:PackIcon Kind="Undo" Width="20" Height="20"/>
                </Button>
                <Button x:Name="BtnRedo" Click="Redo_Click"
                        Style="{StaticResource MaterialDesignIconButton}"
                        ToolTip="Redo (Ctrl+Y)" Margin="2">
                    <materialDesign:PackIcon Kind="Redo" Width="20" Height="20"/>
                </Button>
                <Border Width="1" Background="#30FFFFFF" Margin="5,2"/>
                <Button x:Name="BtnPlay" Click="Execute_Click"
                        ToolTip="Execute Workflow (F5)" Margin="2">
                    <Button.Style>
                        <Style TargetType="Button" BasedOn="{StaticResource MaterialDesignIconButton}">
                            <Setter Property="Foreground" Value="#10B981"/>
                        </Style>
                    </Button.Style>
                    <materialDesign:PackIcon Kind="Play" Width="24" Height="24"/>
                </Button>
                <Button x:Name="BtnStop" Click="Stop_Click"
                        Style="{StaticResource MaterialDesignIconButton}"
                        ToolTip="Stop Execution" Margin="2" Foreground="#EF4444" IsEnabled="False">
                    <materialDesign:PackIcon Kind="Stop" Width="24" Height="24"/>
                </Button>
            </StackPanel>
        </Border>

        <!-- Zoom Level Display -->
        <Border VerticalAlignment="Top" HorizontalAlignment="Right"
                Background="#40000000" CornerRadius="8" Padding="10,5" Margin="10">
            <TextBlock x:Name="ZoomLevelText" Text="100%" FontSize="12" Foreground="#CCFFFFFF"/>
        </Border>

        <!-- Minimap -->
        <Border x:Name="Minimap" VerticalAlignment="Bottom" HorizontalAlignment="Right"
                Width="180" Height="120" Background="#60000000"
                CornerRadius="10" Margin="10" Visibility="Visible">
            <Grid>
                <Canvas x:Name="MinimapCanvas" ClipToBounds="True"/>
                <Border x:Name="MinimapViewport" Background="#208B5CF6"
                        BorderBrush="#8B5CF6" BorderThickness="1"/>
            </Grid>
        </Border>

        <!-- Status Bar -->
        <Border VerticalAlignment="Bottom" HorizontalAlignment="Left"
                Background="#40000000" CornerRadius="8" Padding="10,5" Margin="10">
            <StackPanel Orientation="Horizontal">
                <TextBlock x:Name="StatusText" Text="Ready" FontSize="11" Foreground="#BBFFFFFF"/>
                <TextBlock x:Name="NodeCountText" Text=" | Nodes: 0" FontSize="11" Foreground="#BBFFFFFF"/>
                <TextBlock x:Name="ConnectionCountText" Text=" | Connections: 0" FontSize="11" Foreground="#BBFFFFFF"/>
            </StackPanel>
        </Border>
    </Grid>
</UserControl>
